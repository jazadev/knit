<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Knit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'civic-primary': '#0f172a',
                        'civic-accent': '#3b82f6',
                    },
                    animation: {
                        'fade-in-down': 'fadeInDown 0.5s ease-out',
                        'fade-out-up': 'fadeOutUp 0.5s ease-in'
                    },
                    keyframes: {
                        fadeInDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeOutUp: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="{{ url_for('static', filename='js/translations.js') }}?v=5"></script>
    
    <script>
        window.SERVER_USER = {{ user | tojson | safe }};
        
        const DEFAULT_TOPICS = {
            events: { enabled: true, subs: { cultural: true, sports: false, arts: true } },
            services: { enabled: true, subs: { water: true, light: true, potholes: false } },
            institutions: { enabled: false, subs: {} },
            procedures: { enabled: true, subs: {} },
            community: { enabled: false, subs: {} },
            civic: { enabled: false, subs: {} }
        };
    </script>

    <style>
        [x-cloak] { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
    </style>
</head>

<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300"
      x-cloak
      x-data="{ 
          darkMode: localStorage.getItem('theme') === 'dark',
          zoomLevel: parseInt(localStorage.getItem('zoomLevel')) || 100,
          lang: localStorage.getItem('lang') || 'es',
          isLoggedIn: !!window.SERVER_USER,
          mobileMenuOpen: false,
          t: window.CIVIC_DATA || {},
          
          // Modales
          showSettingsModal: false,
          showPrivacyModal: false,
          confirmModal: { show: false, message: '', callback: () => {} },
          
          // Auxiliares
          availableStates: [], 
          errors: {},
          toast: { show: false, message: '', type: 'success' },
          userProfile: {
              name: window.SERVER_USER?.dbProfile?.name || window.SERVER_USER?.name || '',
              email: window.SERVER_USER?.dbProfile?.email || window.SERVER_USER?.preferred_username || '',
              age: window.SERVER_USER?.dbProfile?.age || '',
              gender: window.SERVER_USER?.dbProfile?.gender || '',
              platformLang: window.SERVER_USER?.dbProfile?.platformLang || 'es',
              country: window.SERVER_USER?.dbProfile?.country || '',
              state: window.SERVER_USER?.dbProfile?.state || '',
              phone: window.SERVER_USER?.dbProfile?.phone || '',
              channels: window.SERVER_USER?.dbPreferences?.notifications || { email: false, sms: false },
              topics: window.SERVER_USER?.dbTopics || JSON.parse(JSON.stringify(DEFAULT_TOPICS))
          },

          showToastMessage(msg, type = 'success') {
              this.toast = { show: true, message: msg, type: type };
              setTimeout(() => { this.toast.show = false; }, 3000);
          },

          askConfirm(msgKey, callback) {
              this.confirmModal.message = this.t[this.lang][msgKey];
              this.confirmModal.callback = callback;
              this.confirmModal.show = true;
          },

          updateLocationLogic() {
              if (this.userProfile.country === 'MX') { this.availableStates = [{ code: 'CDMX', label: 'Ciudad de México' }]; } 
              else if (this.userProfile.country === 'GT') { this.availableStates = [{ code: 'GUATE', label: 'Ciudad de Guatemala' }]; } 
              else { this.availableStates = []; }
              
              if (this.userProfile.country && this.availableStates.length > 0) {
                  const isValid = this.availableStates.some(s => s.code === this.userProfile.state);
                  if (!isValid) this.userProfile.state = this.availableStates[0].code;
              } else if (!this.userProfile.country) {
                  this.userProfile.state = '';
              }
          },

          toggleTopic(key) { let isEnabled = this.userProfile.topics[key].enabled; let subs = this.userProfile.topics[key].subs; for (let subKey in subs) { subs[subKey] = isEnabled; } },
          checkParent(topicKey) { this.userProfile.topics[topicKey].enabled = true; },

          // validación del formulario
          validateForm() {
              this.errors = {};
              let isValid = true;
              
              if (!this.userProfile.name.trim()) { 
                  this.errors.name = 'Requerido'; isValid = false; 
              }
              
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!this.userProfile.email.trim() || !emailRegex.test(this.userProfile.email)) {
                  this.errors.email = 'Correo inválido'; isValid = false;
              }
              
              if (this.userProfile.channels.sms) {
                  const maxLen = this.userProfile.country === 'MX' ? 10 : 8;
                  const currentLen = this.userProfile.phone ? this.userProfile.phone.length : 0;
                  if (currentLen === 0) {
                      this.errors.phone = 'Requerido'; isValid = false;
                  } else if (currentLen !== maxLen) { 
                      this.errors.phone = `Debe ser de ${maxLen} dígitos`; isValid = false; 
                  }
              }
              return isValid;
          },

          async saveProfile() {
              if (!this.validateForm()) {
                  this.showToastMessage('Revisa los errores marcados en rojo', 'error');
                  return;
              }
              
              try {
                  const res = await fetch('/api/save-profile', {
                      method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.userProfile)
                  });
                  
                  if (res.ok) {
                      this.showToastMessage('✅ Guardado correctamente');
                      this.errors = {};
                  } else {
                      this.showToastMessage('❌ Error al guardar', 'error');
                  }
              } catch (e) {
                  console.error(e);
                  this.showToastMessage('⚠️ Error de conexión', 'error');
              }
          },

          async deleteAccount(inputText) {
              const requiredWord = this.t[this.lang].keyword_delete; 
              
              if (inputText && inputText.trim().toLowerCase() === requiredWord.toLowerCase()) {
                  try {
                      // Llamar al backend para borrar de Cosmos DB
                      const res = await fetch('/api/delete-account', { method: 'POST' });
                      
                      if (res.ok) {
                          this.showToastMessage(this.t[this.lang].msg_goodbye);
                          
                          this.showSettingsModal = false;

                          setTimeout(() => {
                              this.logout();
                          }, 2500);
                          
                      } else {
                          this.showToastMessage('Error al eliminar cuenta', 'error');
                      }
                  } catch (e) {
                      console.error(e);
                      this.showToastMessage('Error de conexión', 'error');
                  }
              } else {
                  this.showToastMessage('Palabra de confirmación incorrecta', 'error');
              }
          },

          notificationsOpen: false,
          showNotificationsModal: false,
          notifications: [{ id: 1, text: 'Bienvenido...', time: 'Hace 5 min', read: false }],
          get hasUnread() { return this.notifications.some(n => !n.read); },
          
          chats: [],
          activeChatId: null,
          loading: false,

          async initChat() {
              // Usuario- cargar de API
              if (this.isLoggedIn) {
                  try {
                      const res = await fetch('/api/chats');
                      if (res.ok) {
                          this.chats = await res.json();
                          this.chats = this.chats.map(c => ({...c, messages: c.messages || []}));
                      }
                  } catch (e) { console.error(e); }
              } 
              // Invitado - cargar de LocalStorage
              else {
                  try {
                      const stored = JSON.parse(localStorage.getItem('civic_chats'));
                      this.chats = Array.isArray(stored) ? stored : [];
                  } catch (e) { this.chats = []; }
              }

              if (this.chats.length > 0) { this.activeChatId = this.chats[0].id; } else { this.activeChatId = null; }
              
              if (!this.isLoggedIn) {
                  this.$watch('chats', val => localStorage.setItem('civic_chats', JSON.stringify(val)));
              }
          },
          createNewChat() { this.activeChatId = null; this.mobileMenuOpen = false; },
          
          async deleteChat(id, event) {
              if(event) event.stopPropagation();
              
              this.askConfirm('msg_confirm_delete_chat', async () => {
                  if (this.isLoggedIn) { 
                      try { 
                          const res = await fetch(`/api/chats/${id}`, { method: 'DELETE' });
                          if (!res.ok) throw new Error('Error deleting');
                      } catch (e) { 
                          this.showToastMessage('Error al borrar chat', 'error');
                          return;
                      } 
                  }
                  this.chats = this.chats.filter(c => c.id !== id);
                  if (this.activeChatId === id) this.activeChatId = this.chats.length > 0 ? this.chats[0].id : null;
              });
          },
          
          async clearAllChats() {
              if (this.chats.length === 0) return;
              
              this.askConfirm('msg_confirm_delete_all', async () => {
                  if (this.isLoggedIn) {
                      try {
                          const res = await fetch('/api/chats', { method: 'DELETE' });
                          if (!res.ok) throw new Error('Error deleting all');
                          this.showToastMessage('Historial eliminado');
                      } catch (e) {
                          this.showToastMessage('Error al borrar historial', 'error');
                          return;
                      }
                  }
                  this.chats = [];
                  this.activeChatId = null;
                  this.mobileMenuOpen = false;
              });
          },
          
          get currentChat() {
              if (!this.activeChatId) return { messages: [] };
              return this.chats.find(c => c.id === this.activeChatId) || { messages: [] };
          },

          async sendMessage(text) {
              if (!text || !text.trim()) return;
              let chat = this.chats.find(c => c.id === this.activeChatId);
              if (!chat) {
                  const newId = this.isLoggedIn ? 'chat_' + Date.now() : Date.now();
                  chat = { id: newId, title: text.substring(0, 30) + '...', messages: [] };
                  this.chats.unshift(chat);
                  this.activeChatId = newId;
              }

              chat.messages.push({ role: 'user', text: text });
              this.loading = true;
              this.scrollToBottom();

              try {
                  const res = await fetch('/chat', { 
                      method: 'POST', headers: {'Content-Type': 'application/json'}, 
                      body: JSON.stringify({ message: text, chatId: chat.id }) 
                  });
                  const data = await res.json();
                  chat.messages.push({ role: 'ai', text: data.response });
              } catch (error) { chat.messages.push({ role: 'ai', text: 'Error de conexión' }); } 
              finally { 
                  this.loading = false; 
                  this.scrollToBottom(); 
                  this.chats = [...this.chats]; 
              }
          },
          
          scrollToBottom() { this.$nextTick(() => { const c = document.getElementById('chat-scroll-area'); if(c) c.scrollTop = c.scrollHeight; }); },

          init() {
              this.initChat();
              if (this.darkMode) document.documentElement.classList.add('dark');
              
              this.$watch('darkMode', val => { localStorage.setItem('theme', val ? 'dark' : 'light'); val ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark'); });
              this.$watch('zoomLevel', val => { document.documentElement.style.fontSize = val + '%'; });
              this.$watch('lang', val => localStorage.setItem('lang', val));
              this.$watch('isLoggedIn', val => localStorage.setItem('isLoggedIn', val));

              // Ejecutar lógica inicial
              this.updateLocationLogic();
              this.$watch('userProfile.country', () => { this.updateLocationLogic(); });

              this.$watch('userProfile.phone', (val) => {
                  if (val) {
                      let clean = val.replace(/[^0-9]/g, ''); // Solo números
                      const max = this.userProfile.country === 'MX' ? 10 : 8;
                      if (clean.length > max) clean = clean.slice(0, max); // Recorte automático
                      if (clean !== val) this.userProfile.phone = clean;
                  }
              });
              
              // Limpieza al cerrar modales
              this.$watch('showSettingsModal', (val) => { if (!val) this.errors = {}; });
          },
          
          toggleTheme() { this.darkMode = !this.darkMode; },
          adjustZoom(a) { this.zoomLevel += a; },
          resetZoom() { this.zoomLevel = 100; },
          toggleLang() { this.lang = this.lang === 'es' ? 'en' : 'es'; },
          login() { window.location.href = '/api/login'; },
          logout() { window.location.href = '/api/logout'; }
      }"
>
    <!-- componentes -->
    {% include 'components/toast.html' %}
    {% include 'components/modals/notifications.html' %}
    {% include 'components/modals/settings.html' %}
    {% include 'components/modals/privacy.html' %}
    {% include 'components/modals/confirm.html' %}

    {% block content %}{% endblock %}
</body>
</html>